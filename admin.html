<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florr.io æœåŠ¡å™¨æ•°æ®ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        .player-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .player-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .player-item:hover {
            background-color: #f8f9fa;
        }
        .player-item.selected {
            background-color: #e3f2fd;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .json-editor {
            font-family: monospace;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 200px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Florr.io æœåŠ¡å™¨æ•°æ®ç®¡ç†</h1>

    <div class="container">
        <h2>å®‰å…¨éªŒè¯</h2>
        <div class="form-group">
            <label for="adminKey">ç®¡ç†å‘˜å¯†é’¥:</label>
            <input type="password" id="adminKey" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥">
        </div>
        <button onclick="setAdminKey()">è®¾ç½®å¯†é’¥</button>
        <div id="authMessage"></div>
    </div>

    <div id="mainContent" class="hidden">
        <div class="container">
            <h2>ç©å®¶åˆ—è¡¨</h2>
            <button onclick="loadPlayers()">åˆ·æ–°ç©å®¶åˆ—è¡¨</button>
            <button onclick="exportData()">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button>
            <button onclick="createBackup()">åˆ›å»ºå¤‡ä»½</button>
            <div id="playerList" class="player-list"></div>
        </div>

        <div class="container">
            <h2>æŸ¥çœ‹/ç¼–è¾‘ç©å®¶æ•°æ®</h2>
            <div class="form-group">
                <label for="playerId">ç©å®¶ID:</label>
                <input type="text" id="playerId" placeholder="è¾“å…¥ç©å®¶IDæˆ–ä»åˆ—è¡¨ä¸­é€‰æ‹©">
                <button onclick="loadPlayerData()">åŠ è½½ç©å®¶æ•°æ®</button>
            </div>

            <div id="playerDataSection" class="hidden">
                <h3>å½“å‰ç©å®¶æ•°æ®:</h3>
                <div id="currentPlayerData" class="json-editor"></div>

                <h3>ä¿®æ”¹æ•°æ® (JSONæ ¼å¼):</h3>
                <div class="form-group">
                    <label for="updateData">æ›´æ–°æ•°æ®:</label>
                    <textarea id="updateData" rows="10" placeholder='ä¾‹å¦‚: {"level": 5, "max_wave_reached": 100}'></textarea>
                </div>
                <button onclick="updatePlayerData()">æ›´æ–°ç©å®¶æ•°æ®</button>
                <button class="danger" onclick="deletePlayer()">åˆ é™¤ç©å®¶</button>
            </div>
        </div>

        <div class="container">
            <h2>æ•°æ®æ¢å¤</h2>
            <div class="form-group">
                <label>ä»å¤‡ä»½æ¢å¤æ•°æ®:</label>
                <button class="danger" onclick="restoreFromBackup()">ä»è‡ªåŠ¨å¤‡ä»½æ¢å¤</button>
            </div>
            <div id="restoreMessage"></div>
        </div>
    </div>

    <div id="globalMessage"></div>

    <script>
        let adminKey = '';
        let currentAdminKey = 'florr_admin_2024'; // ç®¡ç†å‘˜å¯†é’¥

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function setAdminKey() {
            const key = document.getElementById('adminKey').value;
            if (key === currentAdminKey) {
                adminKey = key;
                document.getElementById('authMessage').innerHTML = '<div class="message success">âœ… éªŒè¯æˆåŠŸï¼</div>';
                document.getElementById('mainContent').classList.remove('hidden');
                loadPlayers();
            } else {
                showMessage('authMessage', 'âŒ å¯†é’¥é”™è¯¯ï¼', true);
            }
        }

        async function apiCall(action, method = 'GET', params = null, data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey,  // ä½¿ç”¨HTTPå¤´ä¼ é€’å¯†é’¥
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                // æ„å»ºURLå’Œå‚æ•°
                let url = `/data11dalkh11/${action}`;
                const urlParams = new URLSearchParams();

                // æ·»åŠ å…¶ä»–å‚æ•°ï¼ˆä¸åŒ…æ‹¬admin_keyï¼‰
                if (params) {
                    for (const [key, value] of Object.entries(params)) {
                        urlParams.append(key, value);
                    }
                }

                // å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œå°†å‚æ•°æ·»åŠ åˆ°URL
                if (method === 'GET' && urlParams.toString()) {
                    url += '?' + urlParams.toString();
                }
                // å¦‚æœæ˜¯POSTè¯·æ±‚ï¼Œå°†å‚æ•°æ·»åŠ åˆ°URL
                else if (method === 'POST' && urlParams.toString()) {
                    url += '?' + urlParams.toString();
                }

                console.log('è¯·æ±‚URL:', url);
                console.log('è¯·æ±‚æ–¹æ³•:', method);
                console.log('è¯·æ±‚å¤´:', options.headers);

                const response = await fetch(url, options);
                const result = await response.json();

                if (response.ok) {
                    return result;
                } else {
                    throw new Error(result.error || 'è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                showMessage('globalMessage', `âŒ ${error.message}`, true);
                throw error;
            }
        }

        async function loadPlayers() {
            try {
                const result = await apiCall('list');
                const playerList = document.getElementById('playerList');

                if (result.players && result.players.length > 0) {
                    playerList.innerHTML = result.players.map(player => `
                        <div class="player-item" onclick="selectPlayer('${player.player_id}')">
                            <strong>${player.username || player.client_name}</strong> (ID: ${player.player_id})
                            <br>ç­‰çº§: ${player.level} | æœ€é«˜æ³¢æ¬¡: ${player.max_wave_reached}
                        </div>
                    `).join('');
                } else {
                    playerList.innerHTML = '<p>æš‚æ— ç©å®¶æ•°æ®</p>';
                }
            } catch (error) {
                console.error('åŠ è½½ç©å®¶åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function selectPlayer(playerId) {
            document.getElementById('playerId').value = playerId;

            // é«˜äº®é€‰ä¸­çš„ç©å®¶
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.player-item').classList.add('selected');
        }

        async function loadPlayerData() {
            const playerId = document.getElementById('playerId').value;
            if (!playerId) {
                showMessage('globalMessage', 'è¯·è¾“å…¥ç©å®¶ID', true);
                return;
            }

            try {
                const result = await apiCall('get', 'GET', { player_id: playerId });

                if (result.player_data) {
                    document.getElementById('currentPlayerData').textContent = JSON.stringify(result.player_data, null, 2);
                    document.getElementById('playerDataSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error('åŠ è½½ç©å®¶æ•°æ®å¤±è´¥:', error);
            }
        }

        async function updatePlayerData() {
            const playerId = document.getElementById('playerId').value;
            const updateDataText = document.getElementById('updateData').value;

            if (!playerId || !updateDataText) {
                showMessage('globalMessage', 'è¯·å¡«å†™ç©å®¶IDå’Œæ›´æ–°æ•°æ®', true);
                return;
            }

            try {
                const updates = JSON.parse(updateDataText);
                const data = { player_id: playerId, updates: updates };

                console.log('å‘é€çš„æ›´æ–°æ•°æ®:', data);
                await apiCall('update', 'POST', null, data);  // ä¿®æ­£å‚æ•°é¡ºåº
                showMessage('globalMessage', `âœ… ç©å®¶ ${playerId} çš„æ•°æ®å·²æ›´æ–°`);

                // åˆ·æ–°æ•°æ®
                loadPlayerData();
                loadPlayers();
            } catch (error) {
                showMessage('globalMessage', `âŒ æ›´æ–°å¤±è´¥: ${error.message}`, true);
            }
        }

        async function deletePlayer() {
            const playerId = document.getElementById('playerId').value;
            if (!playerId) {
                showMessage('globalMessage', 'è¯·è¾“å…¥ç©å®¶ID', true);
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç©å®¶ ${playerId} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                await apiCall('delete', 'POST', { player_id: playerId, confirm: true });
                showMessage('globalMessage', `âœ… ç©å®¶ ${playerId} å·²åˆ é™¤`);

                // æ¸…ç©ºç•Œé¢å¹¶åˆ·æ–°
                document.getElementById('playerId').value = '';
                document.getElementById('playerDataSection').classList.add('hidden');
                loadPlayers();
            } catch (error) {
                showMessage('globalMessage', `âŒ åˆ é™¤å¤±è´¥: ${error.message}`, true);
            }
        }

        async function exportData() {
            try {
                // åˆ›å»ºä¸€ä¸ªéšè—çš„è¡¨å•æ¥å¯¼å‡ºæ•°æ®
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/data11dalkh11/export';
                form.target = '_blank';

                // æ·»åŠ admin_keyä½œä¸ºéšè—å­—æ®µ
                const adminKeyInput = document.createElement('input');
                adminKeyInput.type = 'hidden';
                adminKeyInput.name = 'admin_key';
                adminKeyInput.value = adminKey;
                form.appendChild(adminKeyInput);

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);

                showMessage('globalMessage', 'âœ… æ•°æ®å¯¼å‡ºå·²å¼€å§‹');
            } catch (error) {
                showMessage('globalMessage', `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, true);
            }
        }

        async function createBackup() {
            try {
                await apiCall('backup', 'POST');
                showMessage('globalMessage', 'âœ… å¤‡ä»½å·²åˆ›å»º');
            } catch (error) {
                showMessage('globalMessage', `âŒ å¤‡ä»½å¤±è´¥: ${error.message}`, true);
            }
        }

        async function restoreFromBackup() {
            if (!confirm('ç¡®å®šè¦ä»å¤‡ä»½æ¢å¤æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰çš„æ‰€æœ‰æ•°æ®ï¼')) {
                return;
            }

            try {
                await apiCall('restore', 'POST', { confirm: true });
                showMessage('globalMessage', 'âœ… æ•°æ®å·²ä»å¤‡ä»½æ¢å¤');
                loadPlayers();
            } catch (error) {
                showMessage('globalMessage', `âŒ æ¢å¤å¤±è´¥: ${error.message}`, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆå§‹åŒ–é€»è¾‘
        });
    </script>
</body>
</html>